# TrendRadar 架构说明

## 系统总览

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面                              │
├──────────────────────────────┬──────────────────────────────┤
│  React 前端                   │   CLI 命令行                  │
│  frontend/                   │   main.py                     │
│  端口: 5173                   │   批量爬取/定时推送            │
└──────────────────────────────┴──────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    server.py (FastAPI)                       │
│                    端口: 8000                                │
├─────────────────────────────────────────────────────────────┤
│  /api/news/{category}    新闻数据                            │
│  /api/data               大宗商品                            │
│  /api/news/supply-chain  供应链新闻                          │
│  /api/generate-analysis  AI 分析                             │
│  /api/cache/status       缓存状态                            │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   scrapers/     │  │    pacong/      │  │     core/       │
│   国内爬虫       │  │   高级爬虫       │  │    核心模块      │
├─────────────────┤  ├─────────────────┤  ├─────────────────┤
│ unified.py      │  │ browser/        │  │ config.py       │
│ finance.py      │  │  └ applescript  │  │ analyzer.py     │
│ commodity.py    │  │  └ selenium     │  │ statistics.py   │
│ smm.py          │  │  └ cdp          │  │ notifiers/      │
│ plastic21cp.py  │  │ scrapers/       │  │ reporters/      │
│                 │  │  └ bloomberg    │  │                 │
│ 特点: requests  │  │  └ 世界银行      │  │                 │
│ 适用: 国内站点  │  │                 │  │                 │
└─────────────────┘  └─────────────────┘  └─────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├──────────────────┬──────────────────┬───────────────────────┤
│  Redis (缓存)     │  MongoDB (历史)   │  MySQL/SQLite        │
│  端口: 49907     │  commodity_prices │  持久化存储           │
│  TTL: 1小时      │  price_history    │                      │
└──────────────────┴──────────────────┴───────────────────────┘
```

## 目录职责

| 目录 | 职责 | 说明 |
|------|------|------|
| `scrapers/` | 国内财经爬虫 | 基于 requests，快速简单 |
| `pacong/` | 高级爬虫 | 支持 AppleScript/Selenium/CDP 浏览器控制 |
| `core/` | 核心模块 | 配置、分析、统计、推送 |
| `database/` | 数据库层 | MySQL 连接和仓库 |
| `config/` | 配置文件 | YAML 配置 |
| `frontend/` | React 前端 | 供应链面板、数据看板 |

## 两套爬虫对比

| 特性 | scrapers/ | pacong/ |
|------|-----------|---------|
| 实现方式 | requests | 浏览器自动化 |
| 适用场景 | 国内财经站点 | 反爬站点/国际网站 |
| 速度 | 快 | 慢但可靠 |
| 依赖 | 轻量 | 需要 Chrome |

## 配置文件

| 文件 | 用途 |
|------|------|
| `config/config.yaml` | 主配置（API密钥、推送渠道） |
| `config/scrapers.yaml` | 爬虫数据源定义 |
| `pacong/config/settings.yaml` | 高级爬虫配置 |

## 启动方式

```bash
# API 服务
python server.py          # http://localhost:8000

# React 前端
cd frontend
npm run dev               # http://localhost:5173

# CLI 爬取
python main.py

# 高级爬虫
python pacong/main.py
```

## 前端功能模块

### 塑料子分类TAB

塑料（plastics）分类下新增子TAB，按大类区分：

| 子TAB | 说明 | 对应商品 |
|-------|------|----------|
| 全部 | 显示所有塑料商品 | - |
| ABS | 丙烯腈-丁二烯-苯乙烯共聚物 | ABS(华东/华南/华北) |
| PP | 聚丙烯 | PP(华东/华南/华北) |
| PE | 聚乙烯 | PE(华东/华南/华北) |
| PS | 聚苯乙烯 | PS(华东/华南/华北) |
| PVC | 聚氯乙烯 | 待添加 |
| PA66 | 尼龙66 | 待添加 |
| PC | 聚碳酸酯 | 待添加 |
| PET | 聚对苯二甲酸乙二醇酯 | 待添加 |

### 区域折线图

支持同一商品多个区域价格的同时展示：

- **华东** - 蓝色折线 `#3b82f6`
- **华南** - 绿色折线 `#10b981`
- **华北** - 橙色折线 `#f59e0b`

实现组件：
- `CommodityChart.jsx` - 支持 `multiSourceData` 属性
- `CommodityCard.jsx` - 转换和传递 `multiSourceHistory`
- `Dashboard.jsx` - 生成 `displayCommodities` 包含区域数据

## 中塑在线爬虫

`scrapers/plastic21cp.py` 负责爬取中塑在线的塑料价格数据：

| 产品 | 区域 | SID |
|------|------|-----|
| ABS | 华东/华南/华北 | 1028/1029/... |
| PP | 华东/华南/华北 | 1011/1128/1127 |
| PE | 华东/华南/华北 | 1013/1130/1129 |
| PS | 华东/华南/华北 | 1014/1132/1131 |

数据流：
1. 爬虫抓取 → 2. MongoDB 存储 → 3. API 返回 → 4. 前端渲染