<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendRadar - 热点新闻聚合</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-radar text-blue-500 mr-2"></i>TrendRadar
                    </h1>
                    <p class="text-gray-500 mt-1">热点新闻聚合与推送服务</p>
                </div>
                <div id="status" class="flex items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    <span class="text-green-600">服务运行中</span>
                </div>
            </div>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i class="fas fa-layer-group text-blue-500"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm">数据源</p>
                        <p id="platformCount" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-full">
                        <i class="fas fa-tags text-green-500"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm">分类</p>
                        <p id="categoryCount" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-full">
                        <i class="fas fa-bell text-purple-500"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm">推送渠道</p>
                        <p id="pushChannel" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="flex items-center">
                    <div class="p-3 bg-orange-100 rounded-full">
                        <i class="fas fa-newspaper text-orange-500"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-gray-500 text-sm">今日新闻</p>
                        <p id="newsCount" class="text-2xl font-bold">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Panel -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-play-circle text-green-500 mr-2"></i>快速操作
            </h2>
            <div class="flex flex-wrap gap-3">
                <button onclick="crawlCategory('finance')" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                    <i class="fas fa-chart-line mr-2"></i>爬取财经
                </button>
                <button onclick="crawlCategory('news')" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                    <i class="fas fa-newspaper mr-2"></i>爬取新闻
                </button>
                <button onclick="crawlCategory('tech')" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                    <i class="fas fa-microchip mr-2"></i>爬取科技
                </button>
                <button onclick="crawlCategory('all')" class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                    <i class="fas fa-sync mr-2"></i>全部爬取
                </button>
            </div>
            <div id="crawlStatus" class="mt-4 text-gray-600 hidden">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                <span>正在爬取...</span>
            </div>
        </div>

        <!-- Categories -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-folder-open text-yellow-500 mr-2"></i>分类管理
            </h2>
            <div id="categories" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Categories will be loaded here -->
            </div>
        </div>

        <!-- News List -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-list text-blue-500 mr-2"></i>最新数据
                </h2>
                <select id="categoryFilter" onchange="loadNews(this.value)" class="px-4 py-2 border rounded-lg">
                    <option value="">选择分类</option>
                </select>
            </div>
            <div id="newsList" class="space-y-3">
                <p class="text-gray-500 text-center py-8">选择分类查看数据</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';

        // 加载状态
        async function loadStatus() {
            try {
                const res = await fetch(`${API_BASE}/api/status`);
                const data = await res.json();
                document.getElementById('platformCount').textContent = data.config.platforms_count;
                document.getElementById('categoryCount').textContent = data.config.categories_count;
                document.getElementById('pushChannel').textContent = data.config.wework_configured ? '企业微信' : '未配置';
            } catch (e) {
                console.error('加载状态失败:', e);
            }
        }

        // 加载分类
        async function loadCategories() {
            try {
                const res = await fetch(`${API_BASE}/api/categories`);
                const data = await res.json();
                
                // 填充卡片
                const container = document.getElementById('categories');
                container.innerHTML = data.categories.map(cat => `
                    <div class="border rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="loadNews('${cat.id}')">
                        <h3 class="font-bold text-lg">${cat.name}</h3>
                        <p class="text-gray-500 text-sm mt-1">${cat.keywords.slice(0, 5).join('、')}...</p>
                    </div>
                `).join('');

                // 填充下拉框
                const select = document.getElementById('categoryFilter');
                // 保留第一个选项
                select.innerHTML = '<option value="">选择分类</option>';
                data.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    select.appendChild(option);
                });

            } catch (e) {
                console.error('加载分类失败:', e);
            }
        }

        // 爬取分类
        async function crawlCategory(category) {
            const statusEl = document.getElementById('crawlStatus');
            statusEl.classList.remove('hidden');
            statusEl.querySelector('span').textContent = `正在爬取 ${category}...`;

            try {
                const res = await fetch(`${API_BASE}/api/crawl`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category, include_custom: true })
                });
                const data = await res.json();
                
                statusEl.innerHTML = `<i class="fas fa-check text-green-500 mr-2"></i><span>完成！${data.message}</span>`;
                document.getElementById('newsCount').textContent = data.total;
                
                // 自动加载新闻
                loadNews(category);
                
                setTimeout(() => statusEl.classList.add('hidden'), 3000);
            } catch (e) {
                statusEl.innerHTML = `<i class="fas fa-times text-red-500 mr-2"></i><span>爬取失败: ${e.message}</span>`;
            }
        }

        // 加载新闻
        async function loadNews(category) {
            if (!category) return;
            
            const container = document.getElementById('newsList');
            container.innerHTML = '<p class="text-gray-500 text-center py-8 loading">加载中...</p>';
            
            document.getElementById('categoryFilter').value = category;

            try {
                const res = await fetch(`${API_BASE}/api/news/${category}?include_custom=true`);
                const data = await res.json();
                
                document.getElementById('newsCount').textContent = data.total;
                
                if (data.data.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">暂无数据</p>';
                    return;
                }

                container.innerHTML = data.data.slice(0, 50).map((item, i) => `
                    <div class="border-b pb-3 hover:bg-gray-50 px-2 py-2 rounded transition">
                        <div class="flex items-start">
                            <span class="text-gray-400 mr-3">${i + 1}</span>
                            <div class="flex-1">
                                <a href="${item.url}" target="_blank" class="text-gray-800 hover:text-blue-500">
                                    ${item.title}
                                </a>
                                <div class="text-gray-400 text-sm mt-1">
                                    <span class="bg-gray-100 px-2 py-0.5 rounded">${item.platform_name || item.platform}</span>
                                    ${item.source === 'custom' ? '<span class="bg-blue-100 text-blue-600 px-2 py-0.5 rounded ml-1">自定义</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = `<p class="text-red-500 text-center py-8">加载失败: ${e.message}</p>`;
            }
        }

        // 初始化
        loadStatus();
        loadCategories();
    </script>
</body>
</html>
