# 铜价问题分析与修复计划

## 问题现象
后端日志持续报告铜价异常：
```
⚠️ 价格异常警告 [copper]: 价格 13309.0 高于最大值 800 (USc/磅)
```

同时 COMEX铜价正常：
```
comex_copper: 602.11 (USc/磅)
```

## 数据流分析

### 1. 数据来源

| 来源 | 商品名称 | 原始价格 | 实际单位 | ID映射 |
|------|----------|----------|----------|--------|
| 新浪期货 | COMEX铜 | ~602 | USc/磅 | comex_copper |
| Business Insider | Copper | ~13,309 | USD/吨 | copper |
| 上海有色网 | SMM铜 | ~73,000 | CNY/吨 | (自定义) |

### 2. 数据转换验证

COMEX铜 602 USc/磅 转换为 USD/吨：
- 602 USc/磅 = 6.02 USD/磅
- 6.02 USD/磅 × 2204.62 磅/吨 = **13,272 USD/吨** ✅

Business Insider 报价 13,309 USD/吨 与 COMEX 报价一致（正常市场波动范围内）。

## 问题根因

### 根因1: PRICE_RANGES 定义错误

**文件**: `database/mysql/pipeline.py` (第143-144行)

```python
PRICE_RANGES = {
    # 工业金属 - 注意不同单位
    'copper': (100, 800, 'USc/磅'),       # ❌ 错误！Business Insider 是 USD/吨
    'comex_copper': (100, 800, 'USc/磅'),  # ✅ 正确
}
```

**问题**: `copper` 的范围定义为 USc/磅，但 Business Insider 的 Copper 实际上是 **USD/吨**。

### 根因2: 爬虫已正确设置单位，但验证逻辑未考虑

**文件**: `pacong/scrapers/business_insider.py` (第89行)
```python
self.commodity_units = {
    'Copper': 'USD/吨',  # ✅ 爬虫正确设置
}
```

**文件**: `scrapers/commodity.py` (第46行)
```python
COMMODITY_UNITS = {
    '铜': 'USc/磅', 'Copper': 'USc/磅',  # ❌ 错误！覆盖了正确设置
}
```

### 根因3: ID映射导致数据混淆

**文件**: `database/mysql/pipeline.py` (第91行)
```python
COMMODITY_ID_MAP = {
    'Copper': 'copper',     # Business Insider → copper (USD/吨)
    'COMEX铜': 'comex_copper',  # 新浪期货 → comex_copper (USc/磅)
}
```

两个不同单位的铜被映射到不同的ID，这本身是正确的。但：
1. 前端可能会错误地将它们合并显示
2. 价格验证范围只考虑了一种单位

## 修复方案

### 方案A: 分离 copper 和 comex_copper（推荐）

#### 步骤1: 修复 PRICE_RANGES

```python
# database/mysql/pipeline.py
PRICE_RANGES = {
    # 工业金属
    'copper': (5000, 20000, 'USD/吨'),      # Business Insider (LME报价)
    'comex_copper': (100, 800, 'USc/磅'),   # 新浪期货 (COMEX报价)
}
```

#### 步骤2: 修复 scrapers/commodity.py 的单位映射

```python
# scrapers/commodity.py
COMMODITY_UNITS = {
    # 保留 COMEX铜的美分单位
    'COMEX铜': 'USc/磅',
    # Copper (Business Insider) 不在这里定义，使用其自身的单位
}
```

#### 步骤3: 前端保持 copper 和 comex_copper 分开显示

在 `Dashboard_Optimized.jsx` 的 `COMMODITY_ALIASES` 中：
```javascript
// 保持分开，不合并
'Copper': 'LME铜',           // Business Insider → LME铜
'COMEX铜': 'COMEX铜',        // 新浪期货 → COMEX铜
'COMEX Copper': 'COMEX铜',
```

### 方案B: 统一转换为 USD/吨（备选）

在入库前将所有铜价统一转换为 USD/吨：
- COMEX铜: 价格 × 2204.62 / 100 (USc/磅 → USD/吨)
- Business Insider: 保持不变 (已是 USD/吨)

**缺点**: 丢失原始报价信息，影响专业用户对比不同市场价格。

## 实施计划

### 第一阶段: 后端修复 (立即)

1. 修改 `database/mysql/pipeline.py`:
   - 更新 `PRICE_RANGES` 中 `copper` 的范围为 `(5000, 20000, 'USD/吨')`

2. 修改 `scrapers/commodity.py`:
   - 移除或修正 `Copper` 的单位映射

### 第二阶段: 前端优化 (可选)

1. 在 Dashboard 中将 COMEX铜 和 LME铜 分开显示
2. 添加单位提示，让用户理解不同市场的报价单位

### 第三阶段: 数据质量监控 (后续)

1. 添加跨数据源价格一致性检查
2. 当 COMEX铜转换后的价格与 LME铜偏差 >5% 时发出警告

## 验证检查清单

- [ ] 后端日志不再报告 copper 价格异常
- [ ] 前端铜价显示正确（~13,000 USD/吨 或 ~6 USD/磅）
- [ ] 历史数据图表显示正常
- [ ] 多来源铜价计算逻辑正确
