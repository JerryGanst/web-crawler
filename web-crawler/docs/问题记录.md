# 问题记录（错题本）

## 1. 配置校验脚本与配置文件存在明文凭据

- 标题：配置校验脚本与配置文件存在明文凭据
- 时间：2025-12-17
- 模块/接口：`config/database.yaml`、`docs/todo_list.md`
- 环境与 Nacos 配置：N/A（本项目使用本地 `config/database.yaml` 与环境变量覆盖）
- 现象：配置文件包含 MongoDB/MySQL 明文密码；任务清单中的验证命令存在打印敏感字段风险
- 复现步骤：
  - 打开 `config/database.yaml` 可见 `mongodb.password`、`mysql.password` 为明文
  - 执行 `docs/todo_list.md` 的 `ENV-03` 验证命令（旧版本）会输出 `username/password` 字段
- 根因分类：安全配置泄露（敏感信息未外置/未脱敏）
- 修复方案：
- 将 `docs/todo_list.md` 的 `ENV-03` 验证命令改为布尔校验，避免输出明文
- 保留 `config/database.yaml` 现状（按约束不改动 MongoDB 账号与密码）
- 影响评估：
  - 正向：避免凭据泄露到仓库与控制台输出
  - 注意：需要在运行环境中提供 `MONGODB_*`（以及 MySQL 对应环境变量）才能正常连接
- 源码位置与提交号：
  - `config/database.yaml:21-55`（提交号：N/A）
  - `docs/todo_list.md:28-40`（提交号：N/A）
- 后续防线：
  - 在 CI/提交前检查中加入敏感字段扫描（如 `password:`、`secret`）
  - 统一所有“配置打印/验证脚本”的脱敏输出规范

## 2. Windows 环境缺少 python 命令导致验证失败

- 标题：Windows 环境缺少 python 命令导致验证失败
- 时间：2025-12-17
- 模块/接口：`docs/todo_list.md` 验证命令
- 环境与 Nacos 配置：Windows（本仓库验证使用 `py` 启动器）
- 现象：按任务清单执行 `python -c ...`、`python -m ...` 返回非 0 退出码
- 复现步骤：
  - 在 Windows PowerShell 执行 `python --version` 失败
  - 执行 `py -V` 可正常输出 Python 版本
- 根因分类：环境差异（PATH 未配置 python 可执行命令）
- 修复方案：将任务清单中的验证命令统一改为 `py ...`
- 影响评估：
  - 正向：验证命令在 Windows 默认环境可直接运行
  - 注意：Linux/macOS 仍可使用 `python3`，需按环境替换
- 源码位置与提交号：
  - `docs/todo_list.md:28-38`（提交号：N/A）
- 后续防线：
  - 任务清单验证命令按操作系统预置（Windows 用 `py`，Linux 用 `python3`）

## 3. 迁移脚本子命令后参数不生效

- 标题：迁移脚本子命令后参数不生效
- 时间：2025-12-17
- 模块/接口：`scripts/migrate_sqlite_to_mongo.py`
- 环境与 Nacos 配置：Windows（本仓库验证使用 `py` 启动器；本项目使用本地 `config/database.yaml`）
- 现象：执行 `py .\scripts\migrate_sqlite_to_mongo.py all --dry-run --limit 5` 报错 `unrecognized arguments`
- 复现步骤：
  - 执行 `py .\scripts\migrate_sqlite_to_mongo.py all --dry-run --limit 5`
  - 观察输出：argparse 提示 `--dry-run/--limit` 为未识别参数
- 根因分类：参数解析（argparse 子命令解析范围导致全局参数未被子解析器识别）
- 修复方案：将 `--sqlite-path/--batch-size/--limit/--dry-run` 作为公共参数同时挂到主解析器与各子命令解析器
- 影响评估：
  - 正向：支持 `all --dry-run` 这类“子命令后置参数”写法，提升可用性
  - 风险：无（仅 CLI 参数解析层调整，不触及数据库读写逻辑）
- 源码位置与提交号：
  - `scripts/migrate_sqlite_to_mongo.py:146-159`（提交号：N/A）
- 后续防线：
  - 在任务清单中固定迁移脚本的干跑命令作为回归验证

## 4. 任务清单安全项与账号保留约束冲突

- 标题：任务清单安全项与账号保留约束冲突
- 时间：2025-12-17
- 模块/接口：`docs/todo_list.md`
- 环境与 Nacos 配置：Windows；N/A
- 现象：任务清单 `SEC-01` 的验证命令与“保留 MongoDB 账号密码”的约束冲突，导致验证结论误导
- 复现步骤：
  - 查看 `docs/todo_list.md` 旧版 `SEC-01`：通过判断 `username/password` 为空来“通过”
  - 当配置按约束保留账号密码时，验证命令输出为 `False`，但并不代表存在安全泄露
- 根因分类：需求约束冲突（安全治理目标与配置保留要求不一致）
- 修复方案：
  - 将 `SEC-01` 标记为 Δ，并将验证口径改为“验证命令不打印明文”
- 影响评估：
  - 正向：避免在不改动账号密码前提下产生误判
  - 注意：仍需通过运行环境治理明文凭据的存储方式（本仓库先约束输出侧）
- 源码位置与提交号：
  - `docs/todo_list.md:32`（提交号：N/A）
- 后续防线：
  - 对所有安全任务补充“约束前提”，避免验证口径与约束冲突

## 5. pip 安装依赖时 requirements.txt 编码导致失败

- 标题：pip 安装依赖时 requirements.txt 编码导致失败
- 时间：2025-12-18
- 模块/接口：`requirements.txt`、pip 解析器
- 环境与 Nacos 配置：Windows；Python 3.9（使用 `py` 启动器）；N/A
- 现象：执行 `py -m pip install -r requirements.txt` 抛出 `UnicodeDecodeError: 'gbk' codec can't decode ...`
- 复现步骤：
  - 在 Windows PowerShell 执行 `py -m pip install -r requirements.txt`
  - 观察 pip 堆栈：`auto_decode` 使用系统默认编码（GBK）解码失败
- 根因分类：环境差异（Windows 默认编码）+ 文件编码混入非 ASCII 字符
- 修复方案：
  - 清理并规范 `requirements.txt` 内容，确保为 UTF-8 文本
  - 安装依赖时设置 `PYTHONUTF8=1`：`$env:PYTHONUTF8=1; py -m pip install -r requirements.txt`
- 影响评估：
  - 正向：Windows 下依赖可稳定安装
  - 注意：应保持仓库文件统一 UTF-8，避免再次引入不可解码字符
- 源码位置与提交号：
  - `requirements.txt:1-18`（提交号：N/A）
- 后续防线：
  - 在仓库规范中固定 UTF-8/LF（避免混入不可见字符）
  - 将安装命令统一为 `PYTHONUTF8=1` 以提升兼容性

## 6. 前端依赖要求 Node 20 导致无法启动

- 标题：前端依赖要求 Node 20 导致无法启动
- 时间：2025-12-18
- 模块/接口：`frontend/package.json`、Vite Dev Server
- 环境与 Nacos 配置：Windows；Node.js 16.20.0；N/A
- 现象：执行 `npm run dev` 提示 Vite 需要 Node 20.19+，并报 `crypto.getRandomValues is not a function`
- 复现步骤：
  - 在 `frontend/` 下执行 `npm run dev`
  - 观察输出：Vite 7 校验 Node 版本失败，随后在加载配置阶段抛错
- 根因分类：依赖版本不兼容（构建工具链要求更高 Node 版本）
- 修复方案：
  - 将前端工具链降级到支持 Node 16 的版本（Vite 4 + 对应插件）
  - 将 `react-router-dom` 降级到 v6 以去除 Node 版本约束
  - 调整 ESLint 配置与版本以在 Node 16 下可执行
- 影响评估：
  - 正向：Node 16 环境可启动前端开发服务
  - 注意：新版特性（Vite 7/Router 7）不可用；如升级 Node 可再回滚升级
- 源码位置与提交号：
  - `frontend/package.json:6-30`（提交号：N/A）
  - `frontend/eslint.config.js:1-29`（提交号：N/A）
- 后续防线：
  - 在 `frontend/package.json` 增加 engines 约束并与实际环境一致
  - 依赖升级前先在目标 Node 版本做本地验证

## 7. 多个 /api 接口固定 15-20 秒延迟
- 标题：多个 /api 接口固定 15-20 秒延迟
- 时间：2025-12-18
- 模块/接口：Vite 代理 `/api/*`
- 环境与 Nacos 配置：Windows；Node.js 16+；Vite Proxy
- 现象：访问 `/api/data` 等接口在浏览器侧显示耗时固定为 15 秒或 20 秒，但直连后端 8000 端口仅需毫秒级
- 复现步骤：
  - `vite.config.js` 配置 `proxy` target 为 `http://localhost:8000`
  - 访问 `http://localhost:5173/api/data`
- 根因分类：DNS 解析策略（Node.js 高版本默认优先 IPv6 `::1`，连接 IPv4 服务端时发生超时回退）
- 修复方案：
  - 修改 `vite.config.js`，将 `target` 显式指定为 `http://127.0.0.1:8000`
- 影响评估：
  - 正向：接口响应恢复毫秒级，消除代理层延迟
- 源码位置与提交号：
  - `frontend/vite.config.js:103`（提交号：N/A）
- 后续防线：
  - 所有本地代理配置统一使用 `127.0.0.1` 替代 `localhost`
  - 后端添加 `X-Process-Time` 响应头以区分业务耗时与链路耗时

## 8. Dashboard 汇率重复换算问题

- 标题：Dashboard 汇率重复换算问题
- 时间：2025-12-26
- 模块/接口：`frontend/src/pages/Dashboard_Optimized.jsx`
- 环境与 Nacos 配置：前端显示逻辑
- 现象：在 Dashboard 切换到 CNY 显示时，原本单位为“元/吨”的塑料类商品（ABS/PP等）价格被错误地乘以了汇率（例如 7.2），导致显示价格偏高。
- 复现步骤：
  - 打开 Dashboard，设置显示货币为 CNY。
  - 查看 ABS(华南) 等商品的“当前价格”。
  - 将看到价格约为原始价格的 7.2 倍。
- 根因分类：逻辑错误（`formatPrice` 函数未区分源币种，统一假定为 USD 并乘以汇率）
- 修复方案：
  - 修改 `formatPrice` 增加 `unit` 参数，根据单位判断源币种。
  - 仅当源币种为 USD 且目标为 CNY 时才乘以汇率；源币种为 CNY 则保持不变。
- 影响评估：
  - 正向：塑料等人民币计价商品在 CNY 模式下显示正确价格。
  - 风险：无。
- 源码位置与提交号：
  - `frontend/src/pages/Dashboard_Optimized.jsx:758`（提交号：N/A）
- 后续防线：
  - 前端涉及金额换算的通用函数必须包含源币种参数。
