# TrendRadar SQLite → MongoDB 技术选型文档

## 1. 文档目的与使用方式

### 1.1 目的
- 固化“为什么迁移、选什么、怎么落地”的决策依据，避免对话上下文被截断后遗忘。
- 形成可复用的项目答辩材料：现状、痛点、目标、方案对比、风险与里程碑。
- 作为后续开发与评审的共同基线：所有代码改动围绕本文档的约束与结论。

### 1.2 适用范围
- 本仓库：`d:\itlong\python-project\web-crawler`
- 本次迁移：将 SQLite 承担的“非结构化数据”存储迁移至 MongoDB，并完成历史数据迁移与索引重建。

## 2. 项目现状（与 SQLite 相关的真实落点）

### 2.1 SQLite 承担的数据域
- 新闻、平台配置、关键词匹配、爬取日志、推送记录、分析缓存。
- 现有 schema 来源：`database/migrations/init_schema.sql:16-151`

### 2.2 关键入口与调用链
- SQLite 初始化与连接：`database/connection.py:27-45,53-83,119-157`
- 统一数据库路由（新闻→SQLite）：`database/manager.py:61-104`
- 仓库层（SQLite CRUD）：
  - 新闻/关键词：`database/repositories/news_repo.py:15-335`
  - 平台：`database/repositories/platform_repo.py:14-124`
  - 爬取日志/推送记录：`database/repositories/log_repo.py:15-226`
  - 缓存回退到 SQLite：`database/cache.py:48-112,179-229`

### 2.3 现有 SQLite 设计要点（迁移时必须等价实现）
- 去重：`news` 表存在唯一约束 `UNIQUE(platform_id, title_hash, crawl_date)`（`database/migrations/init_schema.sql:34-67`）。
- 更新逻辑：出现次数递增、排名历史追加、last_seen_at 更新（`database/repositories/news_repo.py:84-112`）。
- 缓存：`analytics_cache` 使用 `expires_at` 实现 TTL 语义（`database/migrations/init_schema.sql:141-151` + `database/cache.py:54-112`）。

## 3. 迁移目标（可验收）

### 3.1 功能目标
- 用 MongoDB 替换 SQLite 的持久化职责：
  - 新闻写入/去重/更新/查询/统计
  - 平台配置与统计
  - 爬取日志与推送记录
  - 分析缓存（TTL）
- 保持上层模块对外行为不变或变更可控：上层尽量不感知底层存储变更。

### 3.2 非功能目标
- 查询性能可控：核心查询维度具备复合索引。
- 迁移过程可回滚：迁移脚本幂等，保留数据校验口径。
- 安全合规：不在文档与日志中暴露任何密钥与凭据。

## 4. 技术选型结论

### 4.1 数据库：MongoDB
选择 MongoDB 的原因（与本项目数据形态贴合）：
- 新闻/扩展字段存在结构差异，文档模型天然适配。
- 更适合后续扩展：全文检索、聚合分析、归档策略、水平扩展。

不选择 SQLite 的原因（在本项目中形成真实约束）：
- Schema 与 SQL/触发器/索引在字段频繁变化下维护成本高。
- 并发与横向扩展能力有限，日志/历史数据量上升后运维与性能风险增大。

### 4.2 Python 驱动与访问模式（建议结论）
- 运行时驱动：优先采用 `motor`（异步）以匹配 FastAPI 的异步调用形态，避免同步驱动阻塞事件循环。
- 迁移脚本：采用 `pymongo`（同步）实现批量迁移与索引初始化，控制复杂度与可观察性。

备注：当前依赖文件未显式包含 MongoDB 驱动（`requirements.txt:1-9`、`pyproject.toml:6-17`），迁移实施阶段补齐并锁定版本。

### 4.3 缓存策略选型
- 现状：Redis 优先，不可用时回退 SQLite（`database/cache.py:179-229`）。
- 迁移后：
  - “持久化侧缓存”改为 MongoDB 的 TTL 集合（替代 `analytics_cache` 表）。
  - 保留 Redis 作为一级缓存（如仍需），MongoDB TTL 作为降级/持久化缓存。

## 5. 设计风格方案（用于“所有页面统一”）

### 5.1 适用范围
- Web 前端页面（`frontend/`）
- 服务端生成的报告页面/HTML 输出（`core/reporters/*`）

### 5.2 视觉基调
- 定位：数据密集型仪表盘（Dashboard）+ 报告阅读（Report）
- 关键词：清晰、克制、强调对比、可扫描

### 5.3 颜色体系（建议）
- 主色：深蓝（用于主按钮/高亮/链接）
- 辅色：青绿（用于“成功/增长”）、橙黄（用于“警告/波动”）、红色（用于“失败/下跌”）
- 中性色：灰阶用于背景、边框、次级文本

### 5.4 排版与密度
- 标题层级固定：H1/H2/H3 语义与字号一致
- 列表与表格优先：长文本拆成要点，避免大段堆叠
- 间距系统：8px 基线，组件内外间距一致

### 5.5 组件规范（页面一致性核心）
- 顶部：全局导航 + 当前数据时间/刷新状态
- 内容：卡片（Card）作为主容器，标题 + 操作区 + 内容区
- 表格：固定表头、列宽策略、空态/加载态/错误态统一
- 图表：同色系映射固定（同一商品/分类颜色不变）
- 状态提示：成功/失败/进行中样式统一，避免多套提示体系

### 5.6 文档与页面统一输出规范
- API 返回字段命名与 UI 展示字段保持一致，避免前端二次解释。
- 报告输出与页面组件采用同一套“标题-小结-要点-表格/图表”的结构。

## 6. 风险与应对

### 6.1 语义风险（从关系型到文档型）
- 外键约束缺失：用应用层校验 + 索引 + 写入顺序保证一致性。
- 事务边界变化：按业务聚合写入；必要时使用 MongoDB 多文档事务（仅在强需求时启用）。

### 6.2 性能风险
- 查询未命中索引导致慢：以“真实接口查询路径”为索引基准，先建核心复合索引。
- 聚合统计代价高：为高频统计预聚合或引入按日/按小时的汇总集合。

### 6.3 迁移风险
- 数据不一致：迁移脚本提供校验口径（条数、去重键唯一性、关键字段对齐）。
- 回滚困难：迁移支持“只写不删”，上线窗口内保留 SQLite 只读对照。

## 7. 落地里程碑（与任务清单联动）

- 里程碑 A：完成 MongoDB schema/索引设计文档并冻结
- 里程碑 B：完成仓库层替换（news/platform/log/cache）并通过接口级验证
- 里程碑 C：完成 SQLite→MongoDB 数据迁移与校验
- 里程碑 D：移除 SQLite 初始化与 SQL 迁移脚本依赖，完成清理与上线准备

