# TrendRadar MongoDB 数据库设计文档（替换 SQLite）

## 1. 设计目标

- 等价覆盖现有 SQLite 数据能力：`platforms/news/keyword_matches/crawl_logs/push_records/analytics_cache`（来源：`database/migrations/init_schema.sql:16-151`）。
- 面向真实查询路径建索引，优先保障：按日期/分类/平台的新闻查询与统计。
- 为缓存与过期清理提供原生 TTL 方案。

## 2. 命名与约定

- 数据库名：`trendradar`
- 集合命名：复数小写（`news`、`platforms`、`crawl_logs`）
- 时间字段：统一使用 MongoDB Date 类型（UTC 存储），API 层按需要格式化输出。
- 软删除：默认不启用；历史清理走 TTL 或归档。

## 3. 集合设计

### 3.1 `platforms`（平台配置）

#### 3.1.1 文档结构
```json
{
  "_id": "zhihu",
  "name": "知乎",
  "category": "social",
  "enabled": true,
  "api_type": "newsnow",
  "crawl_interval_ms": 1000,
  "max_retries": 3,
  "last_crawled_at": "2025-12-17T00:00:00.000Z",
  "total_crawled": 0,
  "success_rate": 1.0,
  "created_at": "2025-12-17T00:00:00.000Z",
  "updated_at": "2025-12-17T00:00:00.000Z"
}
```

#### 3.1.2 索引
- 唯一索引：`_id`
- 辅助索引：`{ category: 1, enabled: 1 }`

#### 3.1.3 与现有代码映射
- 原 SQLite 表：`platforms`（`database/migrations/init_schema.sql:16-29`）
- 原仓库：`database/repositories/platform_repo.py:14-124`

### 3.2 `news`（新闻主集合）

#### 3.2.1 文档结构
```json
{
  "_id": "ObjectId",
  "platform_id": "zhihu",
  "title": "...",
  "title_hash": "md5...",
  "url": "...",
  "mobile_url": "...",

  "current_rank": 1,
  "ranks_history": [1, 2, 3],
  "hot_value": 12345,

  "first_seen_at": "2025-12-17T00:00:00.000Z",
  "last_seen_at": "2025-12-17T00:05:00.000Z",
  "crawled_at": "2025-12-17T00:05:00.000Z",
  "crawl_date": "2025-12-17",
  "published_at": null,

  "appearance_count": 1,
  "weight_score": 0,
  "category": "social",
  "extra_data": {
    "raw": "..."
  }
}
```

#### 3.2.2 核心约束（替代 SQLite UNIQUE）
- 唯一索引：`{ platform_id: 1, title_hash: 1, crawl_date: 1 }`（对应 `database/migrations/init_schema.sql:65-66`）

#### 3.2.3 查询索引（按真实接口/仓库方法）
- 今日/按分类：`{ crawl_date: 1, category: 1, weight_score: -1, current_rank: 1 }`
- 按平台+日期：`{ platform_id: 1, crawl_date: 1 }`
- 关键词搜索（标题 LIKE）：建议走全文索引
  - 文本索引：`{ title: "text" }`
  - 如果需要更强搜索能力，预留后续 Atlas Search/独立搜索服务方案

#### 3.2.4 更新语义（替代 SQL json_insert 与计数递增）
- appearance 更新：`$inc: { appearance_count: 1 }`
- last_seen_at：`$set: { last_seen_at: now }`
- current_rank：`$set` 或按“仅当更优”策略更新
- ranks_history 追加：`$push: { ranks_history: new_rank }`，必要时用 `$slice` 保留最近 N 条

#### 3.2.5 与现有代码映射
- 原 SQLite 表：`news`（`database/migrations/init_schema.sql:34-67`）
- 原仓库：`database/repositories/news_repo.py:15-262`

### 3.3 `keyword_matches`（关键词匹配）

#### 3.3.1 两种实现策略（设计决策）

方案 A：独立集合（与现状最接近）
- 优点：与现有统计口径一致，写入与查询边界清晰
- 缺点：读新闻时可能需要额外查询或聚合

方案 B：内嵌到 `news`（把匹配结果放在 news 文档里）
- 优点：读新闻时天然带匹配信息，减少 JOIN/二次查询
- 缺点：匹配记录变多会拉大 news 文档；统计需要 unwind

本项目建议：先用方案 A（稳定复刻现状），待查询压力明确后再考虑内嵌优化。

#### 3.3.2 文档结构（方案 A）
```json
{
  "_id": "ObjectId",
  "news_id": "ObjectId",
  "keyword_group": "AI",
  "keywords_matched": ["AI", "人工智能"],
  "matched_at": "2025-12-17T00:00:00.000Z",
  "title": "...",
  "platform_id": "zhihu",
  "crawl_date": "2025-12-17"
}
```

#### 3.3.3 索引
- `{ crawl_date: 1, keyword_group: 1 }`（支撑热门关键词统计）
- `{ news_id: 1 }`
- `{ matched_at: -1 }`

#### 3.3.4 映射
- 原 SQLite 表：`keyword_matches`（`database/migrations/init_schema.sql:72-85`）
- 原仓库：`database/repositories/news_repo.py:264-335`

### 3.4 `crawl_logs`（爬取任务日志）

#### 3.4.1 文档结构
```json
{
  "_id": "ObjectId",
  "task_id": "uuid",
  "started_at": "2025-12-17T00:00:00.000Z",
  "finished_at": null,
  "duration_ms": 0,

  "platforms_crawled": ["zhihu", "weibo"],
  "total_news": 0,
  "new_news": 0,
  "failed_platforms": [],

  "status": "pending",
  "error_message": null,
  "platform_results": []
}
```

#### 3.4.2 索引
- 唯一索引：`{ task_id: 1 }`
- 查询索引：`{ started_at: -1 }`、`{ status: 1, started_at: -1 }`

#### 3.4.3 映射
- 原 SQLite 表：`crawl_logs`（`database/migrations/init_schema.sql:90-111`）
- 原仓库：`database/repositories/log_repo.py:15-135`

### 3.5 `push_records`（推送记录）

#### 3.5.1 文档结构
```json
{
  "_id": "ObjectId",
  "channel": "feishu",
  "report_type": "当日汇总",
  "status": "success",
  "error_message": null,

  "news_count": 50,
  "keyword_groups": ["AI"],
  "message_batches": 1,
  "message_hash": "md5...",

  "pushed_at": "2025-12-17T00:00:00.000Z",
  "push_date": "2025-12-17"
}
```

#### 3.5.2 索引
- `{ push_date: 1, channel: 1, status: 1 }`（支撑“今日是否已推送”）
- `{ pushed_at: -1 }`

#### 3.5.3 映射
- 原 SQLite 表：`push_records`（`database/migrations/init_schema.sql:116-136`）
- 原仓库：`database/repositories/log_repo.py:137-226`

### 3.6 `analytics_cache`（分析缓存，TTL）

#### 3.6.1 文档结构
```json
{
  "_id": "cache_key",
  "cache_type": "trend",
  "result": {"any": "json"},
  "created_at": "2025-12-17T00:00:00.000Z",
  "expires_at": "2025-12-17T01:00:00.000Z"
}
```

#### 3.6.2 索引
- 唯一索引：`_id`
- TTL 索引：`{ expires_at: 1 }`，`expireAfterSeconds: 0`

#### 3.6.3 映射
- 原 SQLite 表：`analytics_cache`（`database/migrations/init_schema.sql:141-151`）
- 原实现：`database/cache.py:48-112`

## 4. SQLite → MongoDB 字段映射（迁移口径）

### 4.1 通用规则
- SQLite `INTEGER PRIMARY KEY AUTOINCREMENT`：迁移为 MongoDB `_id:ObjectId`，同时保留 `sqlite_id`（可选）用于回溯。
- SQLite `TEXT(JSON)` 字段：迁移时解析为对象/数组；解析失败保留原始字符串到 `*_raw` 字段。
- SQLite DATETIME 字符串：迁移为 Date。

### 4.2 关键映射表

| SQLite 表 | Mongo 集合 | 关键字段映射 | 关键约束/索引 |
|---|---|---|---|
| `platforms` | `platforms` | `id`→`_id` | `_id` 唯一；`category+enabled` |
| `news` | `news` | `id`→`_id`；`extra_data`→`extra_data`对象 | `platform_id+title_hash+crawl_date` 唯一 |
| `keyword_matches` | `keyword_matches` | `news_id` 需映射为 Mongo `_id` | `crawl_date+keyword_group` |
| `crawl_logs` | `crawl_logs` | `task_id` 唯一 | `task_id` 唯一；`status+started_at` |
| `push_records` | `push_records` | `push_date` + `channel` 查询 | `push_date+channel+status` |
| `analytics_cache` | `analytics_cache` | `cache_key`→`_id` | TTL: `expires_at` |

## 5. 典型查询与聚合（替代 SQL）

- 按日期/分类取新闻：`find({ crawl_date, category }).sort({ weight_score:-1, current_rank:1 }).limit(n)`
- 按日期统计平台新闻量：`aggregate([{$match:{crawl_date}}, {$group:{_id:"$platform_id", total:{$sum:1}}}])`
- 热门关键词：`aggregate([{$match:{crawl_date}}, {$group:{_id:"$keyword_group", c:{$sum:1}}}, {$sort:{c:-1}}, {$limit:n}])`
- 今日是否已推送：`findOne({ push_date: today, channel, status: "success" })`

