# TrendRadar 功能模块说明

## 概述
- 目标：聚合新闻与大宗商品数据，提供缓存优先的高性能 API，支持 AI 报告与 MCP 工具化分析
- 核心策略：缓存优先 + 异步刷新 + 启动预热 + 定时任务
- 主要模块：服务层/API 路由、爬虫系统、数据层与管道、核心配置与历史、AI 分析、MCP 工具、调度与缓存、配置文件

## 模块清单与职责
- 服务与路由
  - `server.py:51-57` 启动 FastAPI 应用与生命周期管理
  - `api/routes/__init__.py:11-17` 聚合注册数据/新闻/报告/分析/缓存子路由
  - `server.py:69-87` API 状态端点列出主要接口
- 缓存与调度
  - `api/cache.py:26-86` Redis 首选、内存降级的通用缓存
  - `api/scheduler.py:27-56` 启动预热、周期刷新任务
- 爬虫系统
  - `scrapers/unified.py:14-24` 统一数据源管理器（newsnow + 自定义源）
  - `scrapers/commodity.py:43-67` 大宗商品多源融合（新浪/SMM/BI/21CP）
  - `scrapers/finance.py:257-268` 财经与科技自定义爬虫注册
  - `scrapers/plastic21cp.py:19-146` 中塑在线产品映射与历史/增量接口
- 数据层与管道
  - `database/manager.py:14-26` 双数据库路由器（新闻→SQLite，商品→MySQL）
  - `database/mysql/pipeline.py:299-302` 商品数据批处理入口
  - `database/mysql/pipeline.py:509-556` 最新价与变更日志查询
- 核心与历史
  - `core/config.py:49-96` 主配置加载与通知通道整合
  - `core/price_history.py:40-76` 保存每日价格历史
  - `core/price_history.py:93-136` 单品历史查询；`core/price_history.py:137-166` 全量历史
- AI 分析
  - `api/routes/analysis.py:463-638` 市场概况生成（商品摘要→AI→缓存）
  - `api/routes/analysis.py:640-899` 供应链分析（双路 API，含 Gemini 解析）
  - `api/routes/analysis_v3.py:135-178` 模块化第一轮并行（客户/友商/原材料/关税）
  - `api/routes/analysis_v3.py:181-211,213-251,306-443` 第二轮整合与最终报告
- MCP 工具服务
  - `mcp_server/server.py:41-76` 最新新闻
  - `mcp_server/server.py:79-101` 关注词频率
  - `mcp_server/server.py:104-149` 按日期新闻
  - `mcp_server/server.py:155-217` 话题趋势统一分析
  - `mcp_server/server.py:221-260` 数据洞察统一分析
  - `mcp_server/server.py:264-309` 情感分析
  - `mcp_server/server.py:376-456` 统一搜索
  - `mcp_server/server.py:459-500` 历史相似检索
  - `mcp_server/server.py:505-525` 当前配置
  - `mcp_server/server.py:528-540` 系统状态
  - `mcp_server/server.py:543-575` 手动触发爬取

## API 接口模块
- 数据接口
  - 商品数据（缓存优先、异步刷新）`api/routes/data.py:123-173`
  - 价格历史查询 `api/routes/data.py:176-225`
  - 初始化塑料历史（21CP）`api/routes/data.py:227-290`
  - 数据来源级联 `api/routes/data.py:292-403`
  - 系统配置与状态 `api/routes/data.py:406-430,432-471`
- 新闻接口（缓存优先 + 异步刷新）
  - 大宗商品新闻 `api/routes/news.py:347`
  - 供应链新闻 `api/routes/news.py:401`
  - 关税新闻 `api/routes/news.py:447`
  - 塑料新闻 `api/routes/news.py:495`
  - 分类新闻通用端点 `api/routes/news.py:543`
  - 触发爬取 `api/routes/news.py:595`
  - 刷新任务状态 `api/routes/news.py:623`
- 报告接口
  - 报告列表与渲染 `api/routes/reports.py:242-257`
- 分析接口
  - 市场概况（AI）`api/routes/analysis.py:463-638`
  - 供应链分析（AI）`api/routes/analysis.py:640-899`
  - 模块化分析（V3）`api/routes/analysis_v3.py:306-443`
- 缓存接口
  - 状态/清理/删除键 `api/routes/cache.py:9-22,24-33,35-49`

## 爬虫模块说明
- 统一数据源管理器 `scrapers/unified.py`
  - 并发抓取 newsnow 平台 `scrapers/unified.py:110-135`
  - 财经/科技/大宗自定义源补充 `scrapers/unified.py:137-204,206-219`
  - YAML 配置加载 `scrapers/unified.py:76-87`（`config/scrapers.yaml`）
- 商品爬虫 `scrapers/commodity.py`
  - 新浪期货（黄金/白银/WTI/天然气/铜）`scrapers/commodity.py:98-143`
  - 上海有色网（铜铝锌铅镍锡）`scrapers/commodity.py:223-286`
  - Business Insider 表格解析 `scrapers/commodity.py:69-97,145-220`
  - 中塑在线 WTI/塑料增量 `scrapers/commodity.py:288-311`
- 财经/科技爬虫 `scrapers/finance.py`
  - 新浪外汇 `scrapers/finance.py:13-69`
  - CoinGecko 加密货币 `scrapers/finance.py:72-117`
  - Hacker News `scrapers/finance.py:119-161`
  - 东方财富供应链筛选 `scrapers/finance.py:163-234`
- 塑料历史/增量 `scrapers/plastic21cp.py:155-240,227-231`

## 数据存储与管道说明
- 路由与仓库
  - 新闻写入与查询（SQLite）`database/manager.py:84-103,97-104`
  - 商品写入与查询（MySQL）`database/manager.py:131-147,148-161`
- 商品数据管道（MySQL）
  - 批处理入口 `database/mysql/pipeline.py:299-302`
  - 最新价格与变更日志 `database/mysql/pipeline.py:509-556`
- 价格历史（Redis）
  - 每日快照保存 `core/price_history.py:40-76,168-189`
  - 单品/全量历史查询 `core/price_history.py:93-136,137-166`

## AI 分析模块说明
- 市场概况：商品摘要→选择内/外网模型→生成与缓存 `api/routes/analysis.py:463-638`
- 供应链分析：新闻融合（实时+缓存）→质量预检→双路 API 调用（含 Gemini 解析）`api/routes/analysis.py:640-899`
- 模块化分析 V3：第一轮四模块并行→第二轮整合→最终报告组装 `api/routes/analysis_v3.py:135-178,181-211,213-251,306-443`

## MCP 工具服务说明
- 数据查询：最新新闻/关注词频率/按日新闻 `mcp_server/server.py:41-76,79-101,104-149`
- 分析洞察：话题趋势统一/数据洞察统一/情感分析 `mcp_server/server.py:155-217,221-260,264-309`
- 智能检索：统一搜索/历史相似检索 `mcp_server/server.py:376-456,459-500`
- 配置与系统：当前配置/系统状态/手动触发爬取 `mcp_server/server.py:505-525,528-540,543-575`
- 启动模式：stdio/http `mcp_server/server.py:579-610`

## 配置文件说明
- 主配置：AI 双路、爬虫、报告、通知、权重、分类与平台 `config/config.yaml:7-23,24-51,52-109,110-115,116-185`
- 自定义爬虫配置：财经/科技/大宗/关税/行业消息 `config/scrapers.yaml:4-20,47-60,118-129,130-186,187-220`

## 缓存与调度说明
- 缓存后端与降级：`api/cache.py:26-86,99-137,138-166`
- 启动预热：`api/scheduler.py:125-157`
- 周期刷新：商品15分钟、财经/科技30分钟、供应链/关税10分钟 `api/scheduler.py:158-200`

## 验证命令与结果摘要
- 验证目标：确认文档已创建且路径正确
- 执行命令：
  - PowerShell：`Get-Item d:\itlong\python-project\web-crawler\docs\功能模块说明.md | Select-Object Name,Length,LastWriteTime`
- 结果摘要：
  - 期望输出包含文件名 `功能模块说明.md`、非零大小 `Length`、最新写入时间 `LastWriteTime`
