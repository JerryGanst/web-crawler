"""
ä¾›åº”é“¾åˆ†ææŠ¥å‘Š AI æç¤ºè¯ V2.2

æ ¸å¿ƒæ€è·¯ï¼šç»™æ–¹å‘ã€ä¸ç»™æ­»æ¡†æ¶
- å‹å•†èŒƒå›´è¦å®Œæ•´ï¼ˆå…‰ç”µæ¨¡å—+è¿æ¥å™¨+ç”µæºï¼‰
- åŸææ–™è¦è¦†ç›–ï¼ˆé‡‘å±+å¡‘æ–™ï¼‰
- ä½†ä¸å¼ºåˆ¶æ¯ä¸ªéƒ½å†™ï¼Œæœ‰æ–™å°±è¯´ã€æ²¡æ–™å°±è·³è¿‡
- é‡ç‚¹æ˜¯"æœ‰æ´è§"ï¼Œä¸æ˜¯"å¡«æ»¡æ ¼å­"
"""

# å¤§å®—ç‰©æ–™å“ç±»
MATERIAL_CATEGORIES = {
    "é‡‘å±ç±»": ["é“œ", "é•", "é”¡", "é”Œ", "é‡‘", "é“", "é“¶"],
    "å¡‘æ–™ç±»": ["PVC", "PA66", "PBT", "LDPE", "ABS", "PP", "PET", "PC"]
}

# å®Œæ•´çš„å‹å•†åˆ—è¡¨ï¼ˆä¸‰å¤§é¢†åŸŸï¼‰
COMPETITORS = {
    "å…‰ç”µæ¨¡å—": ["Credo", "æ—­åˆ›ç§‘æŠ€", "æ–°æ˜“ç››", "å¤©å­šé€šä¿¡", "å…‰è¿…ç§‘æŠ€", "Finisar"],
    "è¿æ¥å™¨": ["å®‰è´¹è¯º", "è«ä»•", "TE", "ä¸­èˆªå…‰ç”µ", "å¾—æ„ç²¾å¯†", "æ„åè‚¡ä»½", "é‡‘ä¿¡è¯º", "åä¸°ç§‘æŠ€"],
    "ç”µæº": ["å¥¥æµ·ç§‘æŠ€", "èˆªå˜‰", "èµ›å°”åº·", "å°è¾¾ç”µå­"]
}

# System Prompt
ANALYSIS_SYSTEM_PROMPT = """ä½ æ˜¯ç«‹è®¯æŠ€æœ¯çš„æˆ˜ç•¥åˆ†æé¡¾é—®ã€‚

**ä½ çš„é£æ ¼**ï¼š
- è¯´äººè¯ï¼Œç»™å¹²è´§
- æœ‰æ´è§ï¼Œä¸å¥—è¯
- æœ‰æ–™å°±æ·±æŒ–ï¼Œæ²¡æ–™å°±è·³è¿‡

**åˆ†æä¸»ä½“**ï¼šç«‹è®¯æŠ€æœ¯ï¼ˆéç«‹è®¯ç²¾å¯†é›†å›¢ï¼‰

**ä¸‰å¤§ä¸šåŠ¡é¢†åŸŸ**ï¼š
- ğŸ’¡ å…‰ç”µæ¨¡å—
- ğŸ”Œ è¿æ¥å™¨
- âš¡ ç”µæº"""


def get_supply_chain_analysis_prompt(
    company_name: str,
    today: str,
    competitors: list,
    upstream: list,
    downstream: list,
    news_summary: str,
    news_count: int,
    commodity_summary: str = ""
) -> str:
    """ç”Ÿæˆä¾›åº”é“¾åˆ†ææŠ¥å‘Šçš„æç¤ºè¯"""
    
    return f"""# åˆ†æä»»åŠ¡
ä¸º**ç«‹è®¯æŠ€æœ¯**ç”Ÿæˆä¸€ä»½ç«äº‰æ ¼å±€åˆ†ææŠ¥å‘Šã€‚

**æ—¥æœŸ**ï¼š{today}
**æ–°é—»æ•°é‡**ï¼š{news_count}æ¡

# ç«‹è®¯æŠ€æœ¯ç”»åƒ

**ä¸‰å¤§ä¸šåŠ¡é¢†åŸŸ**ï¼š
- ğŸ’¡ **å…‰ç”µæ¨¡å—**ï¼šå…‰æ¨¡å—ã€å…‰çº¤è¿æ¥å™¨
- ğŸ”Œ **è¿æ¥å™¨**ï¼šType-Cã€BTBã€FPCã€æ¿å¯¹æ¿
- âš¡ **ç”µæº**ï¼šå……ç”µå™¨ã€é€‚é…å™¨ã€æ— çº¿å……ç”µ

**ä¸»è¦å®¢æˆ·**ï¼šè‹¹æœã€åä¸ºã€Metaã€å°ç±³ã€æ±½è½¦å®¢æˆ·

**å‹å•†/ç«äº‰å¯¹æ‰‹**ï¼ˆæŒ‰é¢†åŸŸï¼‰ï¼š
- ğŸ’¡ å…‰ç”µæ¨¡å—ï¼šCredoã€æ—­åˆ›ç§‘æŠ€ã€æ–°æ˜“ç››ã€å¤©å­šé€šä¿¡ã€å…‰è¿…ç§‘æŠ€ã€Finisar
- ğŸ”Œ è¿æ¥å™¨ï¼šå®‰è´¹è¯ºã€è«ä»•ã€TEã€ä¸­èˆªå…‰ç”µã€å¾—æ„ç²¾å¯†ã€æ„åè‚¡ä»½ã€é‡‘ä¿¡è¯ºã€åä¸°ç§‘æŠ€
- âš¡ ç”µæºï¼šå¥¥æµ·ç§‘æŠ€ã€èˆªå˜‰ã€èµ›å°”åº·ã€å°è¾¾ç”µå­

**åŸææ–™å…³æ³¨**ï¼š
- é‡‘å±ï¼šé“œã€é•ã€é”¡ã€é”Œã€é“ï¼ˆè¿æ¥å™¨/çº¿ææˆæœ¬ï¼‰
- å¡‘æ–™ï¼šABSã€PPã€PA66ã€PVCã€PBTã€PCï¼ˆå¤–å£³/æŠ¤å¥—æˆæœ¬ï¼‰

# å®æ—¶æ–°é—»ï¼ˆ{news_count}æ¡ï¼‰
{news_summary if news_summary else 'âš ï¸ å½“å‰æ—¶æ®µæœªæŠ“å–åˆ°ç›¸å…³æ–°é—»'}

# å¤§å®—å•†å“ä»·æ ¼
{commodity_summary if commodity_summary else 'âš ï¸ ä»·æ ¼æ•°æ®æš‚æœªè·å–'}

---

# å†™ä½œåŸåˆ™

1. **æœ‰æ–™å°±è¯´ï¼Œæ²¡æ–™å°±è·³è¿‡** â€” ä¸è¦ä¸ºäº†å¡«è¡¨è€Œç¡¬æ‰¯ä¸ç›¸å…³çš„æ–°é—»
2. **å…ˆè§‚ç‚¹åæ•°æ®** â€” æ¯ä¸ªç« èŠ‚å…ˆè¯´ç»“è®ºï¼Œå†ç”¨è¡¨æ ¼/æ•°æ®æ”¯æ’‘
3. **ç¦æ­¢å¥—è¯** â€” "åŠ å¼ºç ”å‘"ã€"å¯†åˆ‡å…³æ³¨"ã€"çŸ­æœŸæ‰¿å‹ä¸­æœŸå‘å¥½" è¿™ç±»è¯ä¸è¦å†™
4. **å¼•ç”¨æ¥æº** â€” å…³é”®ç»“è®ºé™„ä¸Šæ–°é—»é“¾æ¥

---

# æŠ¥å‘Šç»“æ„

## ä¸€ã€æœ¬å‘¨æ ¸å¿ƒå‘ç°

ç”¨3-5ä¸ªè¦ç‚¹æ¦‚æ‹¬æœ€é‡è¦çš„å‘ç°ï¼Œæ ¼å¼ï¼š
- âœ…/âš ï¸/ğŸ”´ **[ä¸€å¥è¯ç»“è®º]**ï¼šå…·ä½“è¯´æ˜ â€” [æ¥æº](é“¾æ¥)

é‡ç‚¹å…³æ³¨ï¼š
- å®¢æˆ·è®¢å•/æˆ˜ç•¥å˜åŒ–
- å‹å•†é‡å¤§åŠ¨ä½œ
- åŸææ–™ä»·æ ¼å¼‚åŠ¨
- å…³ç¨/æ”¿ç­–é£é™©

---

## äºŒã€å®¢æˆ·åŠ¨æ€

åˆ†æè‹¹æœã€åä¸ºã€Metaã€å°ç±³ç­‰å®¢æˆ·çš„æœ€æ–°åŠ¨å‘ï¼Œé‡ç‚¹å›ç­”ï¼š
- æœ‰ä»€ä¹ˆæ–°è®¢å•æˆ–äº§å“è®¡åˆ’ï¼Ÿ
- å¯¹ç«‹è®¯æŠ€æœ¯å“ªä¸ªä¸šåŠ¡çº¿æœ‰å½±å“ï¼Ÿ

*æ²¡æœ‰ç›¸å…³æ–°é—»å°±ç®€çŸ­è¯´æ˜"æœ¬å‘¨å®¢æˆ·é¢å¹³ç¨³"ï¼Œä¸è¦ç¡¬å‡‘ã€‚*

---

## ä¸‰ã€å‹å•†ç«äº‰åˆ†æ

æŒ‰**ä¸‰å¤§ä¸šåŠ¡é¢†åŸŸ**åˆ†æå‹å•†åŠ¨æ€ï¼š

### ğŸ’¡ å…‰ç”µæ¨¡å—
åˆ†æ Credoã€æ—­åˆ›ç§‘æŠ€ã€æ–°æ˜“ç››ã€å¤©å­šé€šä¿¡ã€å…‰è¿…ç§‘æŠ€ã€Finisar ç­‰çš„åŠ¨æ€ã€‚

### ğŸ”Œ è¿æ¥å™¨
åˆ†æ å®‰è´¹è¯ºã€è«ä»•ã€TEã€ä¸­èˆªå…‰ç”µã€å¾—æ„ç²¾å¯†ã€æ„åè‚¡ä»½ã€é‡‘ä¿¡è¯ºã€åä¸°ç§‘æŠ€ ç­‰çš„åŠ¨æ€ã€‚

### âš¡ ç”µæº
åˆ†æ å¥¥æµ·ç§‘æŠ€ã€èˆªå˜‰ã€èµ›å°”åº·ã€å°è¾¾ç”µå­ ç­‰çš„åŠ¨æ€ã€‚

*æ¯ä¸ªé¢†åŸŸï¼šæœ‰æ–°é—»å°±åˆ†æï¼Œæ²¡æ–°é—»å°±å†™"æœ¬å‘¨æš‚æ— é‡å¤§åŠ¨æ€"ã€‚ä¸è¦æŠŠæ²¡æ–°é—»çš„å‹å•†ç¡¬å¡è¿›è¡¨æ ¼ã€‚*

### ç«äº‰åŠ›é›·è¾¾å›¾ï¼ˆå¯é€‰ï¼‰
å¦‚æœæœ‰è¶³å¤Ÿä¿¡æ¯æ”¯æ’‘ï¼Œå¯ä»¥ç»™å‡ºç«äº‰åŠ›å¯¹æ¯”ã€‚

---

## å››ã€åŸææ–™è¡Œæƒ…

åˆ†æåŸææ–™ä»·æ ¼å¯¹æˆæœ¬çš„å½±å“ï¼Œè¦†ç›–ï¼š
- **é‡‘å±**ï¼šé“œã€é•ã€é”¡ã€é”Œã€é“
- **å¡‘æ–™**ï¼šABSã€PPã€PA66ã€PVCã€PBTã€PC

é‡ç‚¹è¯´æ˜ï¼š
- å“ªäº›åŸææ–™æœ¬å‘¨æœ‰æ˜æ˜¾æ¶¨è·Œï¼Ÿ
- å¯¹ç«‹è®¯å“ªä¸ªä¸šåŠ¡çº¿æˆæœ¬å½±å“æœ€å¤§ï¼Ÿ

*æœ‰ä»·æ ¼æ•°æ®å°±åˆ†æï¼Œæ²¡æœ‰å°±è·³è¿‡ã€‚*

---

## äº”ã€å…³ç¨/æ”¿ç­–å½±å“

å¦‚æœ‰ç›¸å…³æ–°é—»åˆ™åˆ†æï¼Œæ— åˆ™ç®€çŸ­è¯´æ˜"æœ¬å‘¨æ— é‡å¤§æ”¿ç­–å˜åŒ–"ã€‚

---

## å…­ã€SWOTåˆ†æ

åŸºäºæœ¬å‘¨ä¿¡æ¯ï¼Œåˆ—å‡ºå…³é”®çš„ä¼˜åŠ¿/åŠ£åŠ¿/æœºä¼š/å¨èƒã€‚
**æ¯æ¡å¿…é¡»æœ‰å…·ä½“ä¾æ®**ï¼Œä¸è¦å†™ç©ºæ³›çš„è¯ã€‚

---

## ä¸ƒã€è¡ŒåŠ¨å»ºè®®

ç»™å‡º**å…·ä½“å¯æ‰§è¡Œ**çš„å»ºè®®ï¼Œæ ¼å¼ï¼š
- é’ˆå¯¹ä»€ä¹ˆé—®é¢˜
- å»ºè®®ä»€ä¹ˆåŠ¨ä½œ
- ç”±è°è´Ÿè´£
- é¢„æœŸæ•ˆæœ

**ç¦æ­¢å†™**ï¼š"åŠ å¼ºç®¡ç†"ã€"æŒç»­ä¼˜åŒ–"ã€"å¯†åˆ‡å…³æ³¨" ç­‰å¥—è¯ã€‚

---

# æ ¼å¼è§„èŒƒ

- æ–°é—»é“¾æ¥ï¼š[æ ‡é¢˜](url)
- æ²¡æœ‰æ•°æ®çš„åœ°æ–¹å†™"â€”"æˆ–è·³è¿‡ï¼Œä¸è¦ç¼–é€ 
- æŠ¥å‘Šé•¿åº¦ï¼šæ ¹æ®å†…å®¹å¤šå°‘çµæ´»è°ƒæ•´ï¼Œæœ‰æ–™å¤šå†™ã€æ²¡æ–™å°‘å†™
"""


def precheck_news_quality(news_list: list) -> dict:
    """é¢„æ£€æ–°é—»è´¨é‡"""
    customer_keywords = ["è‹¹æœ", "Apple", "åä¸º", "Huawei", "Meta", "iPhone", "iPad", "å°ç±³", "OPPO", "vivo"]
    
    # å®Œæ•´çš„å‹å•†å…³é”®è¯ï¼ˆä¸‰å¤§é¢†åŸŸï¼‰
    competitor_keywords = [
        # å…‰ç”µæ¨¡å—
        "Credo", "æ—­åˆ›", "ä¸­é™…æ—­åˆ›", "æ–°æ˜“ç››", "å¤©å­š", "å…‰è¿…", "Finisar", "å…‰æ¨¡å—",
        # è¿æ¥å™¨
        "å®‰è´¹è¯º", "è«ä»•", "Molex", "TE", "ä¸­èˆªå…‰ç”µ", "å¾—æ„ç²¾å¯†", "æ„å", "é‡‘ä¿¡è¯º", "åä¸°ç§‘æŠ€",
        # ç”µæº
        "å¥¥æµ·", "èˆªå˜‰", "èµ›å°”åº·", "å°è¾¾",
        # é€šç”¨
        "å·¥ä¸šå¯Œè”", "å¯Œå£«åº·", "æ¯”äºšè¿ªç”µå­", "æ­Œå°”", "è“æ€", "é¹é¼", "ä¸œå±±ç²¾å¯†", "é¢†ç›Š"
    ]
    
    tariff_keywords = ["å…³ç¨", "åŠ å¾", "è´¸æ˜“æˆ˜", "å‡ºå£ç®¡åˆ¶", "åˆ¶è£", "301"]
    
    # äº§å“çº¿å…³é”®è¯
    product_keywords = {
        "optical": ["å…‰æ¨¡å—", "å…‰çº¤", "å…‰é€šä¿¡", "800G", "400G", "CPO"],
        "connector": ["è¿æ¥å™¨", "Type-C", "BTB", "FPC", "æ¥æ’ä»¶", "æ¿å¯¹æ¿"],
        "power": ["ç”µæº", "å……ç”µå™¨", "é€‚é…å™¨", "æ— çº¿å……", "å¿«å……", "PD", "æ°®åŒ–é•“"]
    }
    
    # åŸææ–™å…³é”®è¯
    material_keywords = {
        "metal": ["é“œ", "é•", "é”¡", "é”Œ", "é“", "é‡‘", "é“¶", "é“œä»·", "é•ä»·"],
        "plastic": ["å¡‘æ–™", "ABS", "PP", "PA66", "PVC", "PBT", "PC", "LDPE", "PET", "å·¥ç¨‹å¡‘æ–™"]
    }
    
    result = {
        "total_count": len(news_list),
        "has_customer_news": False,
        "has_competitor_news": False,
        "has_tariff_news": False,
        "has_material_news": False,
        "has_metal_news": False,
        "has_plastic_news": False,
        "quality_score": 0,
        "suggestions": [],
        "category_counts": {
            "customer": 0,
            "competitor": 0,
            "optical": 0,
            "connector": 0,
            "power": 0,
            "metal": 0,
            "plastic": 0,
            "tariff": 0
        }
    }
    
    for news in news_list:
        text = news.get("title", "") + news.get("content", "")[:300]
        
        if any(kw in text for kw in customer_keywords):
            result["has_customer_news"] = True
            result["category_counts"]["customer"] += 1
            
        if any(kw in text for kw in competitor_keywords):
            result["has_competitor_news"] = True
            result["category_counts"]["competitor"] += 1
            
        if any(kw in text for kw in tariff_keywords):
            result["has_tariff_news"] = True
            result["category_counts"]["tariff"] += 1
            
        # äº§å“çº¿
        for key, keywords in product_keywords.items():
            if any(kw in text for kw in keywords):
                result["category_counts"][key] += 1
                
        # åŸææ–™
        if any(kw in text for kw in material_keywords["metal"]):
            result["has_metal_news"] = True
            result["has_material_news"] = True
            result["category_counts"]["metal"] += 1
            
        if any(kw in text for kw in material_keywords["plastic"]):
            result["has_plastic_news"] = True
            result["has_material_news"] = True
            result["category_counts"]["plastic"] += 1
    
    # è¯„åˆ†ï¼ˆç®€åŒ–ï¼‰
    score = min(len(news_list) * 3, 30)  # åŸºç¡€åˆ†
    if result["has_customer_news"]: score += 20
    if result["has_competitor_news"]: score += 20
    if result["has_material_news"]: score += 15
    if result["has_tariff_news"]: score += 10
    if result["category_counts"]["optical"] > 0: score += 5
    if result["category_counts"]["connector"] > 0: score += 5
    if result["category_counts"]["power"] > 0: score += 5
    result["quality_score"] = min(score, 100)
    
    # å»ºè®®ï¼ˆç²¾ç®€ï¼‰
    if not result["has_customer_news"]:
        result["suggestions"].append("ç¼ºå°‘å®¢æˆ·ï¼ˆè‹¹æœ/åä¸º/Metaï¼‰æ–°é—»")
    if not result["has_competitor_news"]:
        result["suggestions"].append("ç¼ºå°‘å‹å•†ç›¸å…³æ–°é—»")
    if not result["has_material_news"]:
        result["suggestions"].append("ç¼ºå°‘åŸææ–™ä»·æ ¼æ–°é—»")
    if result["total_count"] < 10:
        result["suggestions"].append(f"æ–°é—»æ€»é‡åå°‘ï¼ˆ{result['total_count']}æ¡ï¼‰")
    
    return result


def get_supplier_analysis_prompt(
    supplier_name: str,
    today: str,
    material_categories: list,
    related_companies: list,
    news_summary: str,
    news_count: int
) -> str:
    """ç”Ÿæˆä¾›åº”å•†åˆ†ææŠ¥å‘Šçš„æç¤ºè¯"""
    return f"""# åˆ†æä»»åŠ¡
ä¸º **{supplier_name}** ç”Ÿæˆä¾›åº”å•†åˆ†ææŠ¥å‘Šã€‚

**æ—¥æœŸ**ï¼š{today}
**åˆ†æè§†è§’**ï¼šä»¥ç«‹è®¯æŠ€æœ¯ä¸ºå®¢æˆ·

# ä¾›åº”å•†ä¿¡æ¯
- åç§°ï¼š{supplier_name}
- ä¾›åº”ç‰©æ–™ï¼š{', '.join(material_categories)}
- ä¸»è¦å®¢æˆ·ï¼š{', '.join(related_companies)}

# ç›¸å…³æ–°é—»ï¼ˆ{news_count}æ¡ï¼‰
{news_summary if news_summary else 'âš ï¸ æš‚æ— ç›¸å…³æ–°é—»'}

---

# æŠ¥å‘Šç»“æ„

## ä¸€ã€ä¾›åº”å•†æ¦‚å†µ
ç®€è¦ä»‹ç»ï¼ˆ2-3å¥è¯ï¼‰

## äºŒã€è¿‘æœŸåŠ¨æ€
æœ‰æ–°é—»å°±åˆ†æï¼Œæ²¡æœ‰å°±è·³è¿‡

## ä¸‰ã€ä¾›åº”èƒ½åŠ›è¯„ä¼°
| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| äº§èƒ½ | /10 | |
| è´¨é‡ | /10 | |
| ä»·æ ¼ | /10 | |

## å››ã€é£é™©ä¸å»ºè®®
å…·ä½“çš„é£é™©ç‚¹å’Œå¯æ‰§è¡Œçš„å»ºè®®

---
æŠ¥å‘Šé•¿åº¦ï¼š500-800å­—
"""
